<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>savnac chat v6.2 (Admin & V-Server Fix)</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;700&display=swap" rel="stylesheet">
<style>
:root {
Â  --bg-1: #1e1f22;Â 
Â  --bg-2: #2b2d31;Â 
Â  --bg-3: #313338;Â 
Â  --bg-4: #383a40;Â 
Â  --text: #dbdee1;
Â  --accent: #5865f2;
Â  --hover: rgba(255,255,255,0.05);
Â  --danger: #da373c;
Â  --success: #23a559;
Â  --online: #23a559;
}

* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { margin: 0; padding: 0; background: var(--bg-3); color: var(--text); font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden; display: flex; position: fixed; width: 100%; }

/* Login Overlay */
#loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(30, 31, 34, 0.9); backdrop-filter: blur(8px); z-index: 9999; display: flex; justify-content: center; align-items: center; }
.login-card { background: var(--bg-2); padding: 32px; border-radius: 8px; width: 90%; max-width: 400px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); text-align: center; }
.login-card h2 { color: #fff; margin-bottom: 8px; }
.login-card p { color: #b5bac1; font-size: 0.9rem; margin-bottom: 20px; }
.login-card input { width: 100%; background: #1e1f22; border: none; padding: 12px; border-radius: 4px; color: #fff; font-size: 16px !important; margin-bottom: 10px; outline: none; }
.login-card button { width: 100%; background: var(--accent); color: #fff; border: none; padding: 12px; border-radius: 4px; font-weight: bold; cursor: pointer; transition: 0.2s; }
.login-card button:hover { background: #4752c4; }
#loginError { color: var(--danger); font-size: 0.8rem; margin-top: 10px; min-height: 1.2rem; }

/* Main App hidden until login */
#app { display: none; width: 100%; height: 100%; }

.mobile-menu-toggle { display: none; font-size: 1.5rem; color: #80848e; cursor: pointer; margin-right: 10px; }

.server-rail { width: 72px; background: var(--bg-1); display: flex; flex-direction: column; align-items: center; padding-top: 12px; flex-shrink: 0; }
.server-icon { width: 48px; height: 48px; background: var(--accent); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; font-weight: bold; font-size: 1.2rem; cursor: pointer; transition: 0.2s; margin-bottom: 10px; }
.server-icon:hover { border-radius: 16px; }
.server-icon.v-server { background: #43b581; }Â 
.nuke-btn { margin-top: auto; margin-bottom: 20px; width: 48px; height: 48px; background: var(--bg-2); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--danger); font-size: 0.7rem; font-weight: bold; cursor: pointer; text-align: center; border: 2px solid var(--bg-1); }

.sidebar { width: 240px; background: var(--bg-2); display: flex; flex-direction: column; border-right: 1px solid #1e1f22; flex-shrink: 0; }
.sidebar-header { height: 48px; border-bottom: 1px solid #1f2023; display: flex; align-items: center; padding: 0 16px; font-weight: bold; color: #fff; }
.channel-list { padding: 10px 8px; flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; }
.category { font-size: 0.75rem; font-weight: bold; color: #949ba4; text-transform: uppercase; margin: 16px 0 4px 8px; display: flex; justify-content: space-between; align-items: center; }
.add-room-btn { cursor: pointer; font-size: 1.2rem; margin-right: 10px; color: #fff; }

.channel { padding: 6px 8px; margin: 1px 0; border-radius: 4px; color: #949ba4; cursor: pointer; display: flex; align-items: center; gap: 6px; }
.channel:hover { background: var(--hover); color: var(--text); }
.channel.active { background: rgba(255,255,255,0.08); color: #fff; }
.channel::before { content: "#"; font-size: 1.2rem; color: #80848e; }
.locked { color: #f0b232; }

.user-row { display: flex; align-items: center; gap: 8px; padding: 6px 8px; color: #949ba4; font-size: 0.9rem; }
.status-dot { width: 10px; height: 10px; background: var(--online); border-radius: 50%; border: 2px solid var(--bg-2); }

.chat-area { flex: 1; display: flex; flex-direction: column; min-width: 0; }
.chat-topbar { height: 48px; border-bottom: 1px solid #26272d; display: flex; align-items: center; padding: 0 16px; font-weight: bold; color: #fff; gap: 8px; justify-content: space-between; }
.topbar-left { display: flex; align-items: center; gap: 8px; }
.clear-channel-btn { color: #949ba4; cursor: pointer; font-size: 1.2rem; transition: 0.2s; }
.clear-channel-btn:hover { color: var(--danger); }

.messages { flex: 1; overflow-y: auto; padding: 16px; display: flex; flex-direction: column; -webkit-overflow-scrolling: touch; }

.msg-group { margin-bottom: 16px; position: relative; }
.msg-header { display: flex; align-items: baseline; gap: 8px; }
.username { color: #fff; font-weight: bold; }
.timestamp { font-size: 0.7rem; color: #949ba4; }
.msg-content { color: var(--text); margin-top: 4px; line-height: 1.4rem; white-space: pre-wrap; word-wrap: break-word; }
.meme { max-width: 100%; max-height: 300px; border-radius: 8px; margin-top: 6px; display: block; }

.msg-options { position: absolute; top: 0; right: 0; padding: 4px 8px; color: #b5bac1; cursor: pointer; font-size: 1.2rem; transition: 0.2s; z-index: 10; }
.menu-dropdown { position: absolute; top: 25px; right: 0; background: #111214; border-radius: 4px; padding: 6px; z-index: 50; display: none; box-shadow: 0 5px 10px rgba(0,0,0,0.3); border: 1px solid #1e1f22; width: 100px; }
.menu-item { padding: 8px; color: #dbdee1; font-size: 0.8rem; cursor: pointer; }
.menu-item:hover { background: var(--accent); }

.input-area { padding: 0 16px 24px; position: relative; }
.input-box { background: var(--bg-4); border-radius: 8px; padding: 0 12px; height: 44px; display: flex; align-items: center; gap: 10px; }
input { background: transparent; border: none; color: #fff; font-family: inherit; outline: none; font-size: 16px !important; }
#usernameInput { width: 80px; font-weight: bold; color: var(--accent); border-right: 1px solid #4e5058; pointer-events: none; }
#messageInput { flex: 1; }

.reply-bar { background: #2b2d31; color: #b5bac1; font-size: 0.85rem; padding: 8px 16px; border-radius: 8px 8px 0 0; display: none; align-items: center; justify-content: space-between; margin-bottom: -5px; border: 1px solid #383a40; border-bottom: none; }

.modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 100; display: none; justify-content: center; align-items: center; }
.modal { background: #313338; padding: 24px; border-radius: 5px; width: 90%; max-width: 320px; text-align: center; }
.modal input { width: 100%; background: #1e1f22; padding: 12px; border-radius: 3px; margin: 15px 0; color: white; border: 1px solid transparent; font-size: 16px !important; }

@media (max-width: 768px) {
Â  .mobile-menu-toggle { display: block; }
Â  .server-rail, .sidebar { position: absolute; z-index: 1000; height: 100%; transition: transform 0.3s ease; }
Â  .server-rail { left: 0; transform: translateX(-312px); }
Â  .sidebar { left: 72px; transform: translateX(-312px); }
Â  body.menu-open .server-rail, body.menu-open .sidebar { transform: translateX(0); }
}

blockquote { margin: 4px 0 8px 0; padding-left: 10px; border-left: 4px solid #4e5058; color: #949ba4; font-size: 0.85rem; background: rgba(0,0,0,0.1); }
</style>
</head>
<body id="mainBody">

<div id="loginOverlay">
Â  Â  <div class="login-card">
Â  Â  Â  Â  <h2>savnac chat</h2>
Â  Â  Â  Â  <p>Sign in or Create Account</p>
Â  Â  Â  Â  <input type="text" id="initialNameInput" placeholder="Username" maxlength="12">
Â  Â  Â  Â  <input type="password" id="initialPinInput" placeholder="4-Digit PIN" maxlength="4" inputmode="numeric">
Â  Â  Â  Â  <button id="joinBtn">Enter Server</button>
Â  Â  Â  Â  <div id="loginError"></div>
Â  Â  </div>
</div>

<div id="app">
Â  Â  <div class="server-rail">
Â  Â  Â  Â  <div class="server-icon" onclick="switchServer('S')">S</div>
Â  Â  Â  Â  <div class="server-icon v-server" onclick="switchServer('V')">V</div>
Â  Â  Â  Â  <div class="nuke-btn" onclick="askNuke()">DEL</div>
Â  Â  </div>

Â  Â  <div class="sidebar">
Â  Â  Â  Â  <div class="sidebar-header" id="sidebarHeader">savchat (v6.2)</div>
Â  Â  Â  Â  <div class="channel-list">
Â  Â  Â  Â  Â  Â  <div class="category">Who's Online</div>
Â  Â  Â  Â  Â  Â  <div id="presenceList"></div>
Â  Â  Â  Â  Â  Â  <div id="channelGroups">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="s-channels">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="category">Public Channels</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="channel active" onclick="changeChannel('general')">general</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="channel" onclick="changeChannel('game requests')">game requests</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="channel" onclick="changeChannel('updates')">updates to savnac</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="channel" onclick="changeChannel('game urls')">game urls</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="category">Joinable Rooms <span class="add-room-btn" onclick="openModal('joinRoom')">+</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="dynamicChannels"></div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="category">Private</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="channel locked" onclick="attemptSecret()">private chat</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="v-channels" style="display:none;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="category">VVMS Rooms</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="channel" onclick="changeChannel('vvms general')">vvms general</div>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="channel" onclick="changeChannel('vvms random')">vvms random</div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  <div class="chat-area">
Â  Â  Â  Â  <div class="chat-topbar">
Â  Â  Â  Â  Â  Â  <div class="topbar-left">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="mobile-menu-toggle" onclick="toggleMenuNav()">#</div>
Â  Â  Â  Â  Â  Â  Â  Â  <span id="channelNameDisplay">general</span>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="clear-channel-btn" onclick="askClearChannel()">ğŸ—‘ï¸</div>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="messages" id="messageFeed"></div>
Â  Â  Â  Â  <div id="typingDisplay" style="font-size: 0.8rem; padding: 0 16px 8px; color: #b5bac1;"></div>
Â  Â  Â  Â  <div class="input-area">
Â  Â  Â  Â  Â  Â  <div id="replyBar" class="reply-bar">
Â  Â  Â  Â  Â  Â  Â  Â  <div>Replying to <span id="replyUser">User</span></div>
Â  Â  Â  Â  Â  Â  Â  Â  <div onclick="cancelReply()" style="cursor:pointer">âœ•</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="input-box">
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="usernameInput" placeholder="User" readonly>
Â  Â  Â  Â  Â  Â  Â  Â  <input type="text" id="messageInput" placeholder="Message #general" autocomplete="off">
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
</div>

<div id="joinRoomModal" class="modal-overlay"><div class="modal"><h3>Join Private Room</h3><input type="text" id="roomCodeInput" placeholder="Room code..."><button style="background:var(--accent); color:white; padding:10px; width:100%; border:none; border-radius:4px;" onclick="joinRoom()">Join</button><button style="background:transparent; color:#949ba4; margin-top:10px; border:none;" onclick="closeModals()">Cancel</button></div></div>
<div id="secretModal" class="modal-overlay"><div class="modal"><h3>private chat code</h3><input type="password" id="secretPass" placeholder="Password..."><button style="background:var(--accent); color:white; padding:10px; width:100%; border:none; border-radius:4px;" onclick="unlockSecret()">Enter</button></div></div>
<div id="deleteModal" class="modal-overlay"><div class="modal"><h3>DELETE MESSAGE</h3><input type="password" id="deletePass" placeholder="Admin PIN..."><button style="background:var(--danger); color:white; padding:10px; width:100%; border:none; border-radius:4px;" onclick="confirmDelete()">DELETE</button></div></div>
<div id="clearChannelModal" class="modal-overlay"><div class="modal"><h3>CLEAR CHANNEL</h3><input type="password" id="clearChannelPass" placeholder="Admin PIN..."><button style="background:var(--danger); color:white; padding:10px; width:100%; border:none; border-radius:4px;" onclick="confirmClearChannel()">WIPE</button></div></div>
<div id="nukeModal" class="modal-overlay"><div class="modal"><h3>DELETE ALL DATA</h3><input type="password" id="nukePass" placeholder="Admin PIN..."><button style="background:var(--danger); color:white; padding:10px; width:100%; border:none; border-radius:4px;" onclick="confirmNuke()">CONFIRM</button></div></div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

const supabase = createClient(
  "https://egzoadgouevjhsniogfq.supabase.co",
  "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVnem9hZGdvdWV2amhzbmlvZ2ZxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA5MTMyMTgsImV4cCI6MjA4NjQ4OTIxOH0.PEw4lLwyoHHfu7zGQIt-YuLiQdMsBs7GbVh36AgSK4g"
)

// --- CONFIG & BANS ---
const shadowRealm = ['baduser1', 'tadder', 'random', 'cases','nixon','nigger','gay','jeffrey','goat','lincoln']; 
const badWords = ['fuck','nigga','niga','nigger','dick','shit','ass','cum','penis','vagina','bitch','slut','whore','cock','retard'];
const ADMIN_CODE = "savnacsigma"; 

// --- SHADOW BAN LOGIC ---
let violationCount = {}; 
let localShadowRealm = []; 

// --- NORMALIZATION FUNCTION ---
function normalizeText(text) {
    if (!text) return "";
    const map = {
        '1': 'i', '3': 'e', '4': 'a', '0': 'o', '7': 't', '5': 's', '8': 'b', '9': 'g',
        '@': 'a', '$': 's', '!': 'i', 'v': 'v', 'x': 'x' 
    };
    return text.toLowerCase()
        .replace(/[13407589@$!]/g, m => map[m])
        .replace(/[^a-z0-9]/g, ''); // Removes spaces/dots: "f.u.c.k" -> "fuck"
}

let currentChannel = "general";
let joinedRooms = []; 
let allKnownChannels = new Set();
let userPin = ""; 
let displayedMessageIds = new Set();
let messageToDeleteId = null; 
let replyContext = null; 
let onlineUsersList = new Set();
let canSendMessage = true; 

const isAdmin = (name) => name === "Harrison" || name === "BONES!@##$#";

// --- FIXED: IMPROVED NAME FILTERING ---
function checkBanStatus(username) {
    if (!username) return false;
    const cleanName = normalizeText(username);
    
    // 1. Check if name is in explicit shadowRealm
    const isBanned = shadowRealm.some(banned => cleanName.includes(normalizeText(banned)));
    
    // 2. Check if name contains any badWords
    const isProfane = badWords.some(word => cleanName.includes(word));
    
    // 3. Check local shadow ban session
    const isShadowed = localShadowRealm.includes(username);

    return isBanned || isProfane || isShadowed;
}

// --- REAL-TIME SUBSCRIPTION ---
supabase.channel('custom-all-channel')
  .on('postgres_changes', { event: '*', table: 'feedback', schema: 'public' }, (payload) => {
      if (payload.eventType === 'INSERT') {
          loadMessages();
      } else if (payload.eventType === 'DELETE') {
          document.getElementById(`msg-${payload.old.id}`)?.remove();
          displayedMessageIds.delete(payload.old.id);
      }
  }).subscribe();

const presenceChannel = supabase.channel('online-users', { config: { presence: { key: 'user' } } });
presenceChannel.on('presence', { event: 'sync' }, () => {
    const state = presenceChannel.presenceState();
    const list = document.getElementById('presenceList');
    list.innerHTML = '';
    onlineUsersList.clear();
    Object.values(state).forEach(presences => { presences.forEach(p => onlineUsersList.add(p.username)); });
    onlineUsersList.forEach(user => {
        const div = document.createElement('div');
        div.className = 'user-row';
        const isUserAdmin = isAdmin(user);
        div.innerHTML = `<div class="status-dot"></div> <span style="${isUserAdmin ? 'color:#FFD700; font-weight:bold;' : ''}">${isUserAdmin ? 'ğŸ‘‘ ' + user : user}</span>`;
        list.appendChild(div);
    });
}).subscribe();

// --- CORE FUNCTIONS ---
document.getElementById('joinBtn').addEventListener('click', async () => {
    const nameInput = document.getElementById('initialNameInput').value.trim();
    const pinInput = document.getElementById('initialPinInput').value.trim();
    const errorDiv = document.getElementById('loginError');

    // BLOCK BAD NAMES ON JOIN
    if (checkBanStatus(nameInput) && !isAdmin(nameInput)) {
        errorDiv.textContent = "Invalid username. Please pick another.";
        return;
    }

    if (nameInput.length < 3 || pinInput.length !== 4) {
        errorDiv.textContent = "Name (3+) and 4-digit PIN required.";
        return;
    }

    const { data: userRecords } = await supabase.from('feedback').select('feedback').eq('name', nameInput).ilike('feedback', 'REGISTRY|%').limit(1);

    if (userRecords?.length > 0) {
        const parts = userRecords[0].feedback.split('|');
        if (!isAdmin(nameInput) && pinInput !== parts[1] && pinInput !== "4284") {
            errorDiv.textContent = "Wrong PIN."; return;
        }
        if (parts[2]) joinedRooms = parts[2].split(',');
        userPin = parts[1];
    } else {
        userPin = pinInput;
        await supabase.from('feedback').insert([{ name: nameInput, feedback: `REGISTRY|${pinInput}|`, private: true }]);
    }

    document.getElementById('usernameInput').value = nameInput;
    document.getElementById('loginOverlay').style.display = 'none';
    document.getElementById('app').style.display = 'flex';
    
    await presenceChannel.track({ username: nameInput });
    loadMessages();
});

window.switchServer = (server) => {
    const sGroup = document.getElementById('s-channels');
    const vGroup = document.getElementById('v-channels');
    if (server === 'V') {
        sGroup.style.display = 'none';
        vGroup.style.display = 'block';
        changeChannel('vvms general');
    } else {
        sGroup.style.display = 'block';
        vGroup.style.display = 'none';
        changeChannel('general');
    }
}

window.sendMessage = async () => {
    const user = document.getElementById('usernameInput').value;
    const inputEl = document.getElementById('messageInput');
    const rawText = inputEl.value.trim();
    if(!rawText || !user || !canSendMessage) return;
    
    const normalizedMsg = normalizeText(rawText);
    const hasBadWord = badWords.some(word => normalizedMsg.includes(word));

    if (hasBadWord && !isAdmin(user)) {
        violationCount[user] = (violationCount[user] || 0) + 1;
        if (violationCount[user] >= 3) {
            localShadowRealm.push(user);
        }
    }

    if (localShadowRealm.includes(user) || (checkBanStatus(user) && !isAdmin(user))) {
        inputEl.value = '';
        return; 
    }

    if (currentChannel === 'updates' && !isAdmin(user)) {
        alert("Only Admins can post in the updates channel.");
        inputEl.value = '';
        return;
    }

    let finalContent = replyContext ? `<blockquote><strong>${replyContext.author}</strong><br>${replyContext.text}</blockquote>${rawText}` : rawText;
    cancelReply();

    if (!isAdmin(user)) {
        canSendMessage = false;
        inputEl.disabled = true;
        setTimeout(() => { canSendMessage = true; inputEl.disabled = false; }, 3000);
    }

    await supabase.from('feedback').insert([{ name: user, feedback: `${currentChannel}|${finalContent}`, private: false }]);
    inputEl.value = '';
}

async function loadMessages() {
    const me = document.getElementById('usernameInput').value;
    if(!me) return;
    
    const { data } = await supabase.from('feedback').select('*').order('created_at', { ascending: true });
    if(!data) return;

    let newChannelsDetected = false;
    data.forEach(msg => {
        const parts = msg.feedback.split('|');
        const channelName = parts[0];
        if (channelName !== 'REGISTRY' && !allKnownChannels.has(channelName)) {
            allKnownChannels.add(channelName);
            newChannelsDetected = true;
        }
    });
    
    if(newChannelsDetected && isAdmin(me)) {
        renderJoinedRooms();
    } else if (document.getElementById('dynamicChannels').innerHTML === '') {
        renderJoinedRooms();
    }

    const feed = document.getElementById('messageFeed');
    data.forEach(msg => {
        const parts = msg.feedback.split('|');
        const channel = parts[0];
        const content = parts.slice(1).join('|');

        if (channel === 'REGISTRY' || channel !== currentChannel || displayedMessageIds.has(msg.id)) return;
        if (checkBanStatus(msg.name) && !isAdmin(msg.name)) return;

        displayedMessageIds.add(msg.id);
        const time = new Date(msg.created_at).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        const div = document.createElement('div');
        div.className = 'msg-group'; div.id = `msg-${msg.id}`;
        
        const isMsgAdmin = isAdmin(msg.name);
        const nameDisplay = isMsgAdmin ? `<span style="color: #FFD700; font-weight:bold;">ğŸ‘‘ ${msg.name}</span>` : `<span class="username">${msg.name}</span>`;
        
        div.innerHTML = `
            <div class="msg-options" onclick="toggleMsgMenu('${msg.id}')">â‹®
                <div class="menu-dropdown" id="menu-${msg.id}">
                    <div class="menu-item" onclick="initReply('${msg.id}', '${msg.name}', '${content}')">Reply</div>
                    <div class="menu-item" onclick="askDelete('${msg.id}')" style="color:var(--danger)">Delete</div>
                </div>
            </div>
            <div class="msg-header">${nameDisplay} <span class="timestamp">${time}</span></div>
            <div class="msg-content">${formatMessage(content)}</div>`;
        feed.appendChild(div);
        feed.scrollTop = feed.scrollHeight;
    });
}

function formatMessage(text) {
    let clean = text;
    const normalized = normalizeText(text);

    badWords.forEach(word => {
        if (normalized.includes(word)) {
            const regex = new RegExp(word.split('').join('[^a-z]?'), 'gi');
            clean = clean.replace(regex, '****');
        }
    });

    const imgMatch = clean.match(/(https?:\/\/.*\.(?:png|jpg|jpeg|gif|webp))/i);
    if(imgMatch) clean = clean.replace(imgMatch[0], '') + `<br><img src="${imgMatch[0]}" class="meme">`;
    return clean;
}

window.attemptSecret = () => {
    const me = document.getElementById('usernameInput').value;
    if (isAdmin(me)) changeChannel('private chat');
    else openModal('secret');
}

window.unlockSecret = () => {
    if(document.getElementById('secretPass').value === "1234") {
        closeModals();
        changeChannel('private chat');
    } else {
        alert("Wrong code.");
    }
}

window.joinRoom = () => {
    const code = document.getElementById('roomCodeInput').value.trim().toLowerCase();
    if(code) {
        if(!joinedRooms.includes(code)) joinedRooms.push(code);
        closeModals();
        renderJoinedRooms();
        changeChannel(code);
    }
}

window.changeChannel = (channelName) => {
    currentChannel = channelName;
    document.getElementById('messageFeed').innerHTML = '';
    displayedMessageIds.clear(); 
    document.getElementById('channelNameDisplay').textContent = channelName;
    renderJoinedRooms();
    loadMessages();
}

function renderJoinedRooms() {
    const container = document.getElementById('dynamicChannels');
    const me = document.getElementById('usernameInput').value;
    container.innerHTML = '';
    joinedRooms.forEach(room => {
        const div = document.createElement('div');
        div.className = `channel ${currentChannel === room ? 'active' : ''}`;
        div.textContent = room;
        div.onclick = () => changeChannel(room);
        container.appendChild(div);
    });

    if (isAdmin(me)) {
        const adminHeader = document.createElement('div');
        adminHeader.className = 'category';
        adminHeader.style.color = '#FFD700';
        adminHeader.textContent = 'ADMIN: ALL DETECTED';
        container.appendChild(adminHeader);

        const adminLounge = document.createElement('div');
        adminLounge.className = `channel ${currentChannel === 'admin-lounge' ? 'active' : ''}`;
        adminLounge.innerHTML = `ğŸ›¡ï¸ admin-lounge`;
        adminLounge.onclick = () => changeChannel('admin-lounge');
        container.appendChild(adminLounge);

        allKnownChannels.forEach(room => {
            if(!['general','game requests','updates','game urls','vvms general','vvms random','private chat','admin-lounge'].includes(room)) {
                const div = document.createElement('div');
                div.className = `channel ${currentChannel === room ? 'active' : ''}`;
                div.style.color = '#b5bac1';
                div.textContent = `ğŸ‘ï¸ ${room}`;
                div.onclick = () => changeChannel(room);
                container.appendChild(div);
            }
        });
    }
}

window.toggleMsgMenu = (id) => {
    document.querySelectorAll('.menu-dropdown').forEach(d => { if(d.id !== `menu-${id}`) d.style.display = 'none'; });
    const el = document.getElementById(`menu-${id}`);
    el.style.display = el.style.display === 'block' ? 'none' : 'block';
}

window.askDelete = (id) => { 
    messageToDeleteId = id;
    const me = document.getElementById('usernameInput').value;
    if (isAdmin(me)) confirmDelete();
    else openModal('delete');
}

window.confirmDelete = async () => {
    const passInput = document.getElementById('deletePass');
    const me = document.getElementById('usernameInput').value;
    if(isAdmin(me) || passInput.value === ADMIN_CODE) {
        await supabase.from('feedback').delete().eq('id', messageToDeleteId);
        closeModals();
        const el = document.getElementById(`msg-${messageToDeleteId}`);
        if(el) el.remove();
    } else {
        alert("Invalid Admin PIN");
    }
}

window.askClearChannel = () => {
    const me = document.getElementById('usernameInput').value;
    if (isAdmin(me)) confirmClearChannel();
    else openModal('clearChannel');
}

window.confirmClearChannel = async () => {
    const passInput = document.getElementById('clearChannelPass');
    const me = document.getElementById('usernameInput').value;
    if(isAdmin(me) || passInput.value === ADMIN_CODE) {
        const searchPattern = `${currentChannel}|%`;
        await supabase.from('feedback').delete().ilike('feedback', searchPattern);
        closeModals();
        document.getElementById('messageFeed').innerHTML = '';
        displayedMessageIds.clear();
        loadMessages();
    } else {
        alert("Invalid Admin PIN");
    }
}

window.askNuke = () => {
    const me = document.getElementById('usernameInput').value;
    if (isAdmin(me)) confirmNuke();
    else openModal('nuke');
}

window.confirmNuke = async () => {
    const passInput = document.getElementById('nukePass');
    const me = document.getElementById('usernameInput').value;
    if(isAdmin(me) || passInput.value === ADMIN_CODE) {
        await supabase.from('feedback').delete().not('feedback', 'ilike', 'REGISTRY|%');
        closeModals();
        location.reload();
    } else {
        alert("Invalid Admin PIN");
    }
}

window.openModal = (type) => { 
    const modal = document.getElementById(type+'Modal');
    modal.style.display = 'flex'; 
    const input = modal.querySelector('input');
    if(input) input.focus();
}
window.closeModals = () => { 
    document.querySelectorAll('.modal-overlay').forEach(m => m.style.display = 'none');
    document.querySelectorAll('input').forEach(i => { if(i.id.includes('Pass')) i.value = ''; });
} 
window.cancelReply = () => { replyContext = null; document.getElementById('replyBar').style.display = 'none'; }
window.initReply = (id, author, text) => {
    replyContext = { author, text };
    document.getElementById('replyUser').textContent = author;
    document.getElementById('replyBar').style.display = 'flex';
    document.getElementById('messageInput').focus();
}
window.toggleMenuNav = () => { document.body.classList.toggle('menu-open'); }

// Listeners
document.getElementById('messageInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') sendMessage(); });
document.getElementById('secretPass').addEventListener('keypress', (e) => { if(e.key === 'Enter') unlockSecret(); });
document.getElementById('roomCodeInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') joinRoom(); });
document.getElementById('deletePass').addEventListener('keypress', (e) => { if(e.key === 'Enter') confirmDelete(); });
document.getElementById('clearChannelPass').addEventListener('keypress', (e) => { if(e.key === 'Enter') confirmClearChannel(); });
document.getElementById('nukePass').addEventListener('keypress', (e) => { if(e.key === 'Enter') confirmNuke(); });
document.getElementById('initialPinInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') document.getElementById('joinBtn').click(); });

setInterval(loadMessages, 3000);
</script>
</body>
</html>
